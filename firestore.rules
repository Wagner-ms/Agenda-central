/**
 * @fileoverview Firestore Security Rules for the "Agenda Central" application.
 *
 * Core Philosophy:
 * This ruleset enforces role-based access control, primarily distinguishing between "coordinators" and "telemarketing" agents.
 * User documents are self-owned, authorizations have public read with restricted write, and schedules are scoped to the telemarketing agent unless the user has the 'coordinator' role.
 *
 * Data Structure:
 * - /authorizations/{authorizationId}: Stores authorization records.
 * - /schedules/{scheduleId}: Stores scheduled appointments.
 * - /users/{userId}: Stores user data (email, name, role).
 * - /roles_coordinator/{userId}: Presence indicates coordinator role.
 *
 * Key Security Decisions:
 * - Listing authorizations is public, but creation/modification requires authentication and valid ownership.
 * - Schedules can only be listed or written to by their associated telemarketing agent, or a coordinator.
 * - Users can only manage their own user documents.
 * - Coordinators are granted elevated privileges based on their presence in the `roles_coordinator` collection.
 *
 * Denormalization for Authorization:
 * - The `schedules` collection denormalizes the `escola` and `atendenteId` from the `authorizations` document to enable efficient list operations without needing to read the parent `authorizations` document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner and the resource exists.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the 'coordinator' role.
     * @return {boolean} True if the user has the 'coordinator' role, false otherwise.
     */
    function isCoordinator() {
      return exists(/databases/(default)/documents/roles_coordinator/$(request.auth.uid));
    }

    /**
     * @description Rules for the /authorizations/{authorizationId} collection.
     * @path /authorizations/{authorizationId}
     * @allow (get, list): Any user can read authorization data.
     * @allow (create): Authenticated users can create authorizations if they set the 'criadoPor' field to their user ID.
     * @allow (update, delete): Only the user who created the authorization can update or delete it, and only if the document exists.
     * @deny (create): Non-authenticated users cannot create authorizations.
     * @deny (update, delete): Attempting to update or delete a non-existent authorization.
     * @principle Public read with owner-only writes, enforces ownership on writes.
     */
    match /authorizations/{authorizationId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.criadoPor == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.criadoPor);
    }

    /**
     * @description Rules for the /schedules/{scheduleId} collection.
     * @path /schedules/{scheduleId}
     * @allow (get): Only the telemarketing agent associated with the schedule or a coordinator can get the schedule.
     * @allow (list): Only the telemarketing agent associated with the schedule or a coordinator can list schedules.
     * @allow (create): Only the telemarketing agent associated with the schedule or a coordinator can create schedules, if atendenteId matches auth.uid.
     * @allow (update, delete): Only the telemarketing agent associated with the schedule or a coordinator can update or delete schedules, and only if the document exists.
     * @deny (create): Creating a schedule where atendenteId does not match auth.uid
     * @deny (update, delete): Attempting to update or delete a non-existent schedule.
     * @principle Shared access pattern with coordinator override, ownership enforced for writes.
     */
    match /schedules/{scheduleId} {
      allow get, list: if isSignedIn() && (resource.data.atendenteId == request.auth.uid || isCoordinator());
      allow create: if isSignedIn() && (request.resource.data.atendenteId == request.auth.uid || isCoordinator());
      allow update, delete: if isSignedIn() && (resource.data.atendenteId == request.auth.uid || isCoordinator()) && resource != null;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get): Any signed-in user can get a user document.
     * @allow (list): Listing users is disallowed for security reasons.
     * @allow (create): A user can create their own user document if the userId matches their auth.uid.
     * @allow (update, delete): A user can update or delete their own user document if the userId matches their auth.uid and the document exists.
     * @deny (create): Creating a user document with a userId that doesn't match the authenticated user.
     * @deny (update, delete): Updating or deleting a non-existent user document.
     * @principle Ownership pattern, enforces user-level access control.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update, delete: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }

    /**
     * @description Rules for the /roles_coordinator/{userId} collection.
     * @path /roles_coordinator/{userId}
     * @allow (get, list): Not applicable, these are typically existence checks.
     * @allow (create): A coordinator can assign themself.
     * @allow (update, delete): Only the user with the coordinator role can update or delete their entry, and only if the document exists.
     * @deny (create): Creating a coordinator role with a userId that doesn't match the authenticated user.
     * @deny (update, delete): Attempting to update or delete a non-existent coordinator role.
     * @principle Self-assignment of coordinator role.
     */
    match /roles_coordinator/{userId} {
        allow get: if isCoordinator() || isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
    }
  }
}