/**
 * @file Firebase Security Rules for the "Agenda Central" application.
 *
 * @corePhilosophy This ruleset enforces role-based access control (coordinator) and ownership-based access control (telemarketing agents) to protect sensitive authorization and schedule data. It prioritizes authorization independence and scalability using denormalization to avoid costly `get()` calls in rules.
 * @dataStructure
 *  - `/authorizations/{authorizationId}`: Stores authorization records, accessible primarily to coordinators.
 *  - `/schedules/{scheduleId}`: Stores schedule data, with denormalized fields for efficient filtering.  Accessible to coordinators and the associated telemarketing agent.
 *  - `/users/{userId}`: Stores user profiles. Accessible only to the user themselves.
 *  - `/roles_coordinator/{userId}`: Presence of a document grants coordinator role. No document contents are validated.
 * @keySecurityDecisions
 *  - Coordinators have broad access based on role membership.
 *  - Telemarketing agents are restricted to schedules they create.
 *  - User listing is disabled.
 *  - Authorization Independence: The `schedules` collection contains denormalized data (`escola` and `atendenteId`) from the `authorizations` collection to enable secure and efficient list operations without relying on `get()` calls to parent documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants or denies access to the user's own profile.
     * @path /users/{userId}
     * @allow (get) User with ID 'user_abc' can read their own profile.
     * @allow (create) User with ID 'user_abc' can create their profile if request.auth.uid == 'user_abc'.
     * @allow (update) User with ID 'user_abc' can update their own profile.
     * @allow (delete) User with ID 'user_abc' can delete their own profile.
     * @deny (get) User with ID 'user_xyz' cannot read profile 'user_abc'.
     * @deny (create) User with ID 'user_xyz' cannot create profile 'user_abc'.
     * @deny (update) User with ID 'user_xyz' cannot update profile 'user_abc'.
     * @deny (delete) User with ID 'user_xyz' cannot delete profile 'user_abc'.
     * @principle Enforces user-ownership for user profiles, ensuring that only the authenticated user can access or modify their own data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants or denies access to authorization records.
     * @path /authorizations/{authorizationId}
     * @allow (get) Coordinator can read any authorization.
     * @allow (create) Coordinator can create authorization records.
     * @allow (update) Coordinator can update any authorization.
     * @allow (delete) Coordinator can delete any authorization.
     * @deny (get) Non-coordinator cannot read an authorization record.
     * @deny (create) Non-coordinator cannot create an authorization record.
     * @deny (update) Non-coordinator cannot update authorization record.
     * @deny (delete) Non-coordinator cannot delete an authorization record.
     * @principle Restricts access to authorization records to users with the 'coordinator' role.
     */
    match /authorizations/{authorizationId} {
      allow get: if isCoordinator();
      allow list: if isCoordinator();
      allow create: if isCoordinator();
      allow update: if isCoordinator();
      allow delete: if isCoordinator();
    }

    /**
     * @description Grants or denies access to schedule records.
     * @path /schedules/{scheduleId}
     * @allow (get) Coordinator can read any schedule.
     * @allow (list) Coordinator can list all schedules.
     * @allow (create) User can create a schedule if they are the atendenteId. Coordinator can create a schedule.
     * @allow (update) User can update schedule if they are the atendenteId and if the document exists. Coordinator can update any schedule if the document exists.
     * @allow (delete) User can delete schedule if they are the atendenteId and if the document exists. Coordinator can delete any schedule if the document exists.
     * @deny (get) Non-coordinator cannot read a schedule if they are not the atendenteId.
     * @deny (list) Non-coordinator cannot list any schedule.
     *
     * @principle Allows coordinators full access to schedules, while telemarketing agents can only manage schedules associated with their atendenteId.  Denormalized atendenteId allows list operation without get().
     */
    match /schedules/{scheduleId} {
      allow get: if isCoordinator() || isAtendente(resource.data.atendenteId);
      allow list: if isCoordinator() || isAtendente(resource.data.atendenteId);
      allow create: if isCoordinator() || (request.resource.data.atendenteId == request.auth.uid);
      allow update: if (isCoordinator() || isExistingAtendente(resource.data.atendenteId)) && resource != null;
      allow delete: if (isCoordinator() || isExistingAtendente(resource.data.atendenteId)) && resource != null;
    }

      /**
       * @description Grants or denies access to coordinator role documents. The presence of a document confers the role; contents are ignored.
       * @path /roles_coordinator/{userId}
       * @allow (get) Any signed-in user can read a coordinator role document.
       * @allow (list) Listing is disallowed.
       * @allow (create) Only a coordinator can grant the coordinator role to another user.
       * @allow (update) Only a coordinator can modify a coordinator role document.
       * @allow (delete) Only a coordinator can revoke the coordinator role from a user.
       * @deny (create) Non-coordinators cannot create coordinator role documents.
       * @deny (update) Non-coordinators cannot modify coordinator role documents.
       * @deny (delete) Non-coordinators cannot delete coordinator role documents.
       * @principle Enforces role-based access control, allowing only existing coordinators to manage coordinator roles.
       */
    match /roles_coordinator/{userId} {
        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isCoordinator();
        allow update: if isCoordinator();
        allow delete: if isCoordinator();
    }

    // ---------- Helper Functions ----------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isCoordinator() {
      return exists(/databases/$(database)/documents/roles_coordinator/$(request.auth.uid));
    }

    function isAtendente(atendenteId) {
        return request.auth.uid == atendenteId;
    }

    function isExistingAtendente(atendenteId) {
      return request.auth.uid == atendenteId && resource != null;
    }
  }
}