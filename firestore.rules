/**
 * @fileoverview Firestore Security Rules for the "Agenda Central" application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model with ownership constraints.
 * Users have specific roles (gestor, coordinator, telemarketing) that determine their data access privileges.
 * Data access is further restricted by ownership, ensuring users can only modify data they own or are explicitly authorized to manage.
 *
 * Data Structure:
 * - /authorizations/{authorizationId}: Stores authorization records.
 * - /schedules/{scheduleId}: Stores scheduled appointments.
 * - /users/{userId}: Stores user data, including roles.
 * - /roles_gestor/{userId}: Presence of a document indicates gestor role.
 * - /roles_coordinator/{userId}: Presence of a document indicates coordinator role.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user IDs match, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of a document.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user IDs match, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the 'gestor' role.
     * @return {boolean} True if the user has the 'gestor' role, false otherwise.
     */
    function isGestor() {
      return exists(/databases/$(database)/documents/roles_gestor/$(request.auth.uid));
    }

    /**
     * @description Checks if the user has the 'coordinator' role.
     * @return {boolean} True if the user has the 'coordinator' role, false otherwise.
     */
    function isCoordinator() {
      return exists(/databases/$(database)/documents/roles_coordinator/$(request.auth.uid));
    }

    /**
     * @description Rules for the /authorizations/{authorizationId} collection.
     */
    match /authorizations/{authorizationId} {
      allow get: if isSignedIn();
      allow list: if isGestor() || isCoordinator();
      allow create: if isSignedIn();
      allow update: if isGestor() || isCoordinator() || isSignedIn();
      allow delete: if isGestor() || isCoordinator();
    }

    /**
     * @description Rules for the /schedules/{scheduleId} collection.
     */
    match /schedules/{scheduleId} {
      allow get: if isCoordinator() || (isSignedIn() && resource.data.atendenteId == request.auth.uid);
      allow list: if isCoordinator() || (isSignedIn() && resource.data.atendenteId == request.auth.uid);
      allow create: if isSignedIn();
      allow update: if isCoordinator() || (isSignedIn() && isExistingOwner(resource.data.atendenteId));
      allow delete: if isCoordinator() || (isSignedIn() && isExistingOwner(resource.data.atendenteId));
    }

    /**
     * @description Rules for the /users/{userId} collection.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
    
    /**
     * @description Rules for the /roles_gestor/{userId} collection.
     */
    match /roles_gestor/{userId} {
      allow read, write: if isGestor();
    }

    /**
     * @description Rules for the /roles_coordinator/{userId} collection.
     */
    match /roles_coordinator/{userId} {
      allow read, write: if isCoordinator() || isGestor();
    }
  }
}
