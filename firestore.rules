/**
 * @fileoverview Firestore Security Rules for the Agenda Central application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user roles and data ownership.
 * Coordinators, identified via their presence in the `roles_coordinator` collection, have broad read access.
 * Telemarketing agents have more restricted access, primarily to schedules assigned to them.
 * General users (unauthenticated) are explicitly denied write access to all data.
 *
 * Data Structure:
 * - /authorizations/{authorizationId}: Authorization records, managed by coordinators and telemarketing.
 * - /schedules/{scheduleId}: Scheduled appointments, linked to Authorizations.
 * - /users/{userId}: User profiles, containing role information.
 * - /roles_coordinator/{userId}: Documents indicating coordinator roles.
 *
 * Key Security Decisions:
 * - Coordinators are granted access by virtue of their document existing in the `roles_coordinator` collection.
 * - Telemarketing agents are associated with schedules via the `atendenteId` field in the `schedules` collection.
 * - Public listing of authorizations is not permitted.
 * - Owner id must be immutable.
 *
 * Denormalization for Authorization:
 * The `schedules` collection denormalizes `escola` and `atendenteId` from `authorizations` to allow for efficient list operations without requiring costly `get()` calls to parent documents.
 *
 * Structural Segregation:
 * Private user data (profiles) are stored in the `/users/{userId}` collection, separate from public or shared data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource, based on the provided userId.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the current user is the owner of the resource and the resource exists.
      * @param {string} userId - The user ID to compare against the resource's owner ID.
      * @return {bool} True if the user is the owner and the resource exists, false otherwise.
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user has the 'coordinator' role.
     * @return {bool} True if the user is a coordinator, false otherwise.
     */
    function isCoordinator() {
      return exists(/databases/$(database)/documents/roles_coordinator/$(request.auth.uid));
    }

    /**
     * @description Rules for the /authorizations collection.
     * @path /authorizations/{authorizationId}
     * @allow (create) - Allow create for anyone, but validates the 'criadoPor' field.
     * @deny (update) - Deny update if the user is not a coordinator.
     * @deny (delete) - Deny delete for any user.
     * @principle Enforces role-based access control for authorization records.
     */
    match /authorizations/{authorizationId} {
      allow get: if isCoordinator();
      allow list: if false; // Listing authorizations is never allowed

      // Error reported here. The rule was missing.
      allow create: if request.resource.data.criadoPor == 'sistema';
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /schedules collection.
     * @path /schedules/{scheduleId}
     * @allow (get) - Allow get for coordinator or if atendenteId matches the user's ID.
     * @allow (list) - Allow list for coordinator or if atendenteId matches the user's ID.
     * @deny (create) - Deny create for any user.
     * @deny (update) - Deny update for any user.
     * @deny (delete) - Deny delete for any user.
     * @principle Enforces role-based access control and telemarketing agent ownership for schedules.
     */
    match /schedules/{scheduleId} {
      allow get: if isCoordinator() || (isSignedIn() && resource.data.atendenteId == request.auth.uid);
      allow list: if isCoordinator() || (isSignedIn() && resource.data.atendenteId == request.auth.uid);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow (get) - Allow get for the owner.
     * @allow (list) - Deny list for all users.
     * @allow (create) - Allow create for the owner.
     * @allow (update) - Allow update for the owner, enforcing immutability of the id field.
     * @allow (delete) - Deny delete for all users.
     * @principle Enforces document ownership and restricts user listing.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId) && (request.resource.data.id == resource.data.id);
      allow delete: if false;
    }

    /**
     * @description Rules for the /roles_coordinator collection.
     * @path /roles_coordinator/{userId}
     * @allow (get) - Allow get for coordinators.
     * @allow (list) - Deny list for all users.
     * @allow (create) - Deny create for all users.
     * @allow (update) - Deny update for all users.
     * @allow (delete) - Deny delete for all users.
     * @principle Restricts access to coordinator role management.
     */
    match /roles_coordinator/{userId} {
      allow get: if isCoordinator();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}