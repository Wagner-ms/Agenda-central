/**
 * @fileoverview Firestore Security Rules for the "Agenda Central" application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model where coordinators have broader access, and telemarketing agents have restricted access based on their user ID.
 * User documents are owner-protected, and coordinator status is determined by presence in the `roles_coordinator` collection.
 *
 * Data Structure:
 * - /authorizations/{authorizationId}: Stores authorization data.
 * - /schedules/{scheduleId}: Stores schedule appointment data, denormalized for efficient querying.
 * - /users/{userId}: Stores user data, including roles.
 * - /roles_coordinator/{userId}: Presence of a document grants coordinator role to the user.
 *
 * Key Security Decisions:
 * - Coordinators are granted broader access based on the `roles_coordinator` collection.
 * - Telemarketing agents are restricted to schedules associated with their user ID.
 * - User listing is disallowed.
 * - Write access to `authorizations` is not yet defined.
 *
 * Denormalization for Authorization:
 * The `schedules` collection denormalizes `escola` and `atendenteId` from `authorizations` to allow `list` operations without requiring costly `get()` calls. This is crucial for efficient querying and scalable security rules.
 * Coordinator role is determined by the presence of a document in the `roles_coordinator` collection, avoiding the need to read user documents for role verification.
 *
 * Structural Segregation:
 * The separation of `authorizations` and `schedules` allows for tailored security rules for each entity, optimizing performance and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is authenticated.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an existing owner.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has coordinator privileges by verifying the existence of a document in the roles_coordinator collection.
     * @returns {boolean} True if the user is a coordinator, false otherwise.
     */
    function isCoordinator() {
      return exists(/databases/$(database)/documents/roles_coordinator/$(request.auth.uid));
    }

    /***************** Authorizations Collection Rules *****************/

    /**
     * @description Manages access to authorization records captured via QR code.
     * @path /authorizations/{authorizationId}
     * @allow (get, list): Public read access.
     * @allow (create): Only if the 'criadoPor' field matches the authenticated user's ID.
     * @allow (update, delete): Only if the user is the owner (as determined by the 'criadoPor' field) and the document exists.
     * @deny Mismatched 'criadoPor' field on create. Unauthorized user trying to update or delete.
     * @principle Public read, owner-only writes, relational integrity on 'criadoPor'.
     */
    match /authorizations/{authorizationId} {
      // Public read access
      allow get, list: if true;

      // Owner-only writes
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /***************** Schedules Collection Rules *****************/

    /**
     * @description Manages access to schedule appointment data.
     * @path /schedules/{scheduleId}
     * @allow (get): Public read access.
     * @allow (list): If the user is a coordinator OR if the user's ID matches the 'atendenteId' OR public read if no auth.
     * @allow (create): If the user is a coordinator OR if the user's ID matches the 'atendenteId'.  Requires atendenteId to match request.auth.uid.
     * @allow (update, delete): If the user is a coordinator OR if the user's ID matches the 'atendenteId' and the document exists.
     * @deny Unauthorized user trying to create, update, or delete.
     * @principle Role-based access, ownership-based access for telemarketing agents, relational integrity on 'atendenteId'.
     */
    match /schedules/{scheduleId} {
      // Public read access
      allow get: if true;
      // Listing can be public if unauthenticated, coordinator, or owned by the atendenteId
      allow list: if isSignedIn() && isCoordinator() || isSignedIn() && request.auth.uid == resource.data.atendenteId || !isSignedIn();

      // Allow creation only if user is coordinator or the atendenteId matches the user
      allow create: if isSignedIn() && isCoordinator() || isSignedIn() && request.resource.data.atendenteId == request.auth.uid;

      // Allow update and delete only if user is coordinator or owns the schedule AND it exists.
      allow update, delete: if isSignedIn() && isCoordinator() || isSignedIn() && request.auth.uid == resource.data.atendenteId && resource != null;
    }

    /***************** Users Collection Rules *****************/

    /**
     * @description Manages access to user data.
     * @path /users/{userId}
     * @allow (get): Only the owner can get their own document.
     * @allow (create): Only the user can create their own document (self-registration). Requires the userId to match request.auth.uid.
     * @allow (update, delete): Only the owner can update or delete their own document, and only if the document exists.
     * @deny Unauthorized user trying to get, create, update, or delete another user's document.
     * @deny Listing of all users (privacy).
     * @principle Owner-only access, self-creation, prevents user listing.
     */
    match /users/{userId} {
      // Owner can get their own document
      allow get: if isOwner(userId);

      // User can create their own document (self-registration)
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;

      // Owner can update and delete their own document (if it exists)
      allow update, delete: if isExistingOwner(userId) && resource.data.id == userId;

      // Prevent listing all users
      allow list: if false;
    }

    /***************** Roles_Coordinator Collection Rules *****************/

    /**
     * @description Manages access to the roles_coordinator collection, granting coordinator privileges.
     * @path /roles_coordinator/{userId}
     * @allow (get): Only coordinators can read coordinator roles.
     * @allow (create): Only coordinators can grant coordinator roles. Requires the userId to match request.auth.uid.
     * @allow (update, delete): Only coordinators can update or delete coordinator roles, and only if the document exists.
     * @deny Unauthorized user trying to get, create, update, or delete coordinator roles.
     * @deny Listing of all coordinator roles.
     * @principle Role-based access control for coordinator roles.
     */
    match /roles_coordinator/{userId} {
      // Only coordinators can read coordinator roles
      allow get: if isCoordinator();

      // Only coordinators can create coordinator roles
      allow create: if isCoordinator() && request.resource.data.id == request.auth.uid;

      // Only coordinators can update and delete coordinator roles (if it exists)
      allow update, delete: if isCoordinator() && isExistingOwner(userId) && resource.data.id == userId;

      // Prevent listing all coordinator roles
      allow list: if false;
    }
  }
}