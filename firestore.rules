/**
 * @file Firebase Security Rules for the "Agenda Central" application.
 *
 * @corePhilosophy This ruleset enforces a role-based access control model, with a strict separation of privileges between regular users and coordinators. It also implements owner-only access for user profiles. Authorization independence is achieved through data denormalization.
 * @dataStructure The data is organized into four top-level collections: `authorizations`, `schedules`, `users`, and `roles_coordinator`.
 * @keySecurityDecisions
 *   - User listing is disallowed.
 *   - Coordinator privileges are granted based on the existence of a document in the `roles_coordinator` collection.
 *   - Read operations are generally more permissive than write operations, but public listing is carefully controlled.
 *   - Data required for authorization is denormalized onto documents to avoid costly `get()` calls in the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the `authorizations` collection, allowing public reads but restricting writes to authorized users.
     * @path /authorizations/{authorizationId}
     * @allow (get, list): Public read access for all users.
     * @allow (create): Only allow if request.auth.uid exists.
     * @allow (update, delete): Only allow if request.auth.uid matches the 'atendenteId' in the existing document.
     * @deny (create): If the 'atendenteId' field in the request does not match the authenticated user's UID.
     * @deny (update, delete): If the document does not exist, or if the user is not the owner.
     * @principle Implements public read access with owner-only writes.
     */
    match /authorizations/{authorizationId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isExistingOwner(resource.data.atendenteId);
    }

    /**
     * @description Secures the `schedules` collection, restricting access based on user role and ownership.
     * @path /schedules/{scheduleId}
     * @allow (get): Public read access for all users.
     * @allow (list): Only allow if the authenticated user is a coordinator or the 'atendenteId' matches the authenticated user's UID.
     * @allow (create): Only allow if the 'atendenteId' matches the authenticated user's UID.
     * @allow (update, delete): Only allow if the 'atendenteId' matches the authenticated user's UID and the document exists.
     * @deny (create, update, delete): If the user is not authorized based on their role or ownership.
     * @principle Implements role-based and owner-only access control.
     */
    match /schedules/{scheduleId} {
      allow get: if true;
      allow list: if isCoordinator() || isOwner(request.auth.uid);
      allow create: if isSignedIn();
      allow update, delete: if isExistingOwner(resource.data.atendenteId);
    }

    /**
     * @description Secures the `users` collection, allowing only the owner to read, update, or delete their own profile, and allowing self-creation.
     * @path /users/{userId}
     * @allow (get, list): Denies listing entirely.
     * @allow (create): Allows a user to create their own profile if the user ID matches the authenticated user's ID.
     * @allow (update, delete): Only allows the owner to update or delete their own profile, and only if the document exists.
     * @deny (create): If the user ID does not match the authenticated user's ID.
     * @deny (update, delete): If the document does not exist, or if the user is not the owner.
     * @principle Enforces strict user-ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the `roles_coordinator` collection, granting coordinator privileges based on document existence.
     * @path /roles_coordinator/{userId}
     * @allow (get, list): Only allows coordinators to read and list documents in this collection.
     * @allow (create): Only allows coordinators to create documents in this collection.
     * @allow (update, delete): Only allows coordinators to update or delete documents in this collection, and only if the document exists.
     * @deny (create, update, delete): If the user is not a coordinator.
     * @principle Implements role-based access control for coordinator privileges.
     */
    match /roles_coordinator/{userId} {
      allow get, list: if isCoordinator();
      allow create: if isCoordinator();
      allow update, delete: if isCoordinator() && resource != null;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
    }

    function isCoordinator() {
        return exists(/databases/$(database)/documents/roles_coordinator/$(request.auth.uid));
    }
  }
}