/**
 * @file Overview
 * Core Philosophy: This ruleset enforces role-based access control (coordinator) and user-based access control (owner) to protect sensitive authorization and schedule data. Authorization and Schedule data are associated with specific users, and access is granted based on user roles and ownership.
 * Data Structure:
 *   - /authorizations/{authorizationId}: Stores authorization records.
 *   - /schedules/{scheduleId}: Stores schedule appointment data.
 *   - /users/{userId}: Stores user data, including role (coordinator, telemarketing).
 *   - /roles_coordinator/{userId}: Grants the 'coordinator' role to a user if the document exists.
 *
 * Key Security Decisions:
 *   - Coordinators can read all authorizations and schedules.
 *   - Users (telemarketing) can only read/write their own schedules.
 *   - Only authenticated users can access any data.
 *   - Listing of all users is disallowed.
 *   - Data validation is relaxed in this prototyping phase, focusing on authorization.
 *   - The `roles_coordinator` collection enables global role-based access control.
 *   - Authorization independence is achieved through denormalization, listing schedules by 'atendenteId' and 'escola'.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource.
     * @param {string} userId - The user ID to check against.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the current user is a coordinator.
      * @return {bool} True if the user has the 'coordinator' role, false otherwise.
      */
    function isCoordinator() {
      return exists(/databases/$(database)/documents/roles_coordinator/$(request.auth.uid));
    }

    /**
     * @description Access control rules for the /authorizations/{authorizationId} collection.
     * @path /authorizations/{authorizationId}
     * @allow (get) Coordinator can read any authorization: auth.uid == coordinator and document exists.
     * @allow (create) Coordinator can create any authorization: auth.uid == coordinator.
     * @allow (update) Coordinator can update any authorization: auth.uid == coordinator and document exists.
     * @allow (delete) Coordinator can delete any authorization: auth.uid == coordinator and document exists.
     * @deny (get) Non-coordinator cannot read authorization: auth.uid != coordinator.
     * @deny (create) Non-coordinator cannot create authorization: auth.uid != coordinator.
     * @deny (update) Non-coordinator cannot update authorization: auth.uid != coordinator.
     * @deny (delete) Non-coordinator cannot delete authorization: auth.uid != coordinator.
     * @principle Enforces role-based access control, allowing coordinators to manage authorizations.
     */
    match /authorizations/{authorizationId} {
      allow get: if isSignedIn() && isCoordinator();
      allow list: if isSignedIn() && isCoordinator();
      allow create: if isSignedIn() && isCoordinator();
      allow update: if isSignedIn() && isCoordinator() && resource != null;
      allow delete: if isSignedIn() && isCoordinator() && resource != null;
    }

    /**
     * @description Access control rules for the /schedules/{scheduleId} collection.
     * @path /schedules/{scheduleId}
     * @allow (get) Coordinator can read any schedule: auth.uid == coordinator.
     * @allow (create) Any authenticated user can create a schedule: isSignedIn().
     * @allow (update) Only the owner (atendenteId) can update a schedule: request.auth.uid == resource.data.atendenteId.
     * @allow (delete) Only the owner (atendenteId) can delete a schedule: request.auth.uid == resource.data.atendenteId.
     *
     * @allow (get) Telemarketing agent can read any schedule: isSignedIn() && request.auth.uid == resource.data.atendenteId.
     * @allow (list) Coordinator can list schedules: isCoordinator().
     * @allow (list) Telemarketing agent can list their own schedules: request.auth.uid == resource.data.atendenteId.
     *
     * @deny (create) Non-authenticated user cannot create: !isSignedIn().
     * @deny (update) Non-owner cannot update a schedule: request.auth.uid != resource.data.atendenteId.
     * @deny (delete) Non-owner cannot delete a schedule: request.auth.uid != resource.data.atendenteId.
     * @principle Enforces role-based and ownership-based access control for schedules. Coordinators have full access, while telemarketing agents are limited to their own schedules.
     */
    match /schedules/{scheduleId} {
      allow get: if isSignedIn() && (isCoordinator() || request.auth.uid == resource.data.atendenteId);
      allow list: if isSignedIn() && (isCoordinator() || request.auth.uid == resource.data.atendenteId);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == resource.data.atendenteId && resource != null;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.atendenteId && resource != null;
    }

    /**
     * @description Access control rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get) Only the owner can read their own user data: isOwner(userId).
     * @allow (create) Only the owner can create their own user data: isOwner(userId) and request.resource.data.id == userId.
     * @allow (update) Only the owner can update their own user data, and the ID is immutable: isOwner(userId) && resource != null && request.resource.data.id == resource.data.id.
     * @allow (delete) Only the owner can delete their own user data: isOwner(userId) && resource != null.
     * @deny (list) Listing of all users is explicitly denied for security reasons.
     * @principle Enforces strict user-ownership for user data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Access control rules for the /roles_coordinator/{userId} collection.
     * @path /roles_coordinator/{userId}
     * @allow (get) Coordinator can get any roles_coordinator document: isCoordinator().
     * @allow (create) Only a coordinator can grant coordinator role: isCoordinator().
     * @allow (update) Only a coordinator can update coordinator role: isCoordinator() and resource != null.
     * @allow (delete) Only a coordinator can revoke coordinator role: isCoordinator() and resource != null.
     * @deny (list) Listing of all roles_coordinator documents is explicitly denied.
     * @principle Role-based access control for managing coordinator roles.
     */
    match /roles_coordinator/{userId} {
      allow get: if isCoordinator();
      allow list: if false;
      allow create: if isCoordinator();
      allow update: if isCoordinator() && resource != null;
      allow delete: if isCoordinator() && resource != null;
    }
  }
}