/**
 * @fileoverview Firestore Security Rules for the "Agenda Central" application.
 *
 * Core Philosophy:
 * This ruleset enforces role-based access control, primarily distinguishing between "coordinators" and "telemarketing" agents.
 * Coordinators have broader access, while telemarketing agents are typically limited to data associated with their own user ID.
 * The design emphasizes authorization independence for `list` operations through data denormalization.
 *
 * Data Structure:
 * - /authorizations/{authorizationId}: Stores authorization data captured via QR code.
 * - /schedules/{scheduleId}: Stores appointment data, denormalized with 'escola' and 'atendenteId' from authorizations.
 * - /users/{userId}: Stores user data, including roles (coordinator, telemarketing).
 * - /roles_coordinator/{userId}: Documents in this collection grant the 'coordinator' role to the user id.
 *
 * Key Security Decisions:
 * - Authorization independence for `schedules` collection is achieved by denormalizing `escola` and `atendenteId`, enabling secure `list` operations without requiring `get()` calls to parent documents.
 * - The `roles_coordinator` collection grants the "coordinator" role to a user if a document exists with their `userId` as the document ID. The content of these documents is ignored.
 * - The rules do not enforce any data validation.
 *
 * Denormalization for Authorization:
 * The `schedules` collection denormalizes the `escola` and `atendenteId` fields from the related `authorizations` document.
 * This allows for secure listing of schedules based on these attributes without requiring costly `get()` calls to parent documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication is required for almost all operations.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces user-based ownership.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user has coordinator role.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces role-based access.
     */
    function isCoordinator() {
        return exists(/databases/$(database)/documents/roles_coordinator/$(request.auth.uid));
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the document.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Verifies document existence and ownership for updates and deletes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /authorizations collection.
     * @path /authorizations/{authorizationId}
     * @allow Signed-in user can read any authorization record. (get)
     * @allow Coordinator can create a new authorization record. (create)
     * @deny Non-coordinator cannot create authorization records. (create)
     * @deny Unauthorized user cannot delete authorization records. (delete)
     * @principle Authorization records should be read publicly but only modified by authorized users.
     */
    match /authorizations/{authorizationId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isCoordinator();
      allow update: if isCoordinator();
      allow delete: if isCoordinator();
    }

    /**
     * @description Rules for the /schedules collection.
     * @path /schedules/{scheduleId}
     * @allow Signed-in user can read any schedule record. (get)
     * @allow Coordinator can create a new schedule record. (create)
     * @deny Non-coordinator cannot create schedule records. (create)
     * @deny Unauthorized user cannot delete schedule records. (delete)
     * @principle Schedule records should be read publicly but only modified by authorized users.
     */
    match /schedules/{scheduleId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isCoordinator();
      allow update: if isCoordinator();
      allow delete: if isCoordinator();
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow User can read their own user document. (get)
     * @allow User can create their own user document if the userId matches their auth.uid. (create)
     * @deny User cannot read other user documents. (get)
     * @deny Non-owner cannot update or delete user documents. (update, delete)
     * @principle Users can only manage their own user data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

     /**
      * @description Rules for the /roles_coordinator collection.
      * @path /roles_coordinator/{userId}
      * @allow Coordinator can create a new coordinator role record. (create)
      * @allow Coordinator can read an existing coordinator role record. (get)
      * @deny Non-coordinator cannot create coordinator role records. (create)
      *
      * @principle Coordinators role can only be granted by existing coordinators.
      */
    match /roles_coordinator/{userId} {
        allow get: if isCoordinator();
        allow list: if false;

        allow create: if isCoordinator();
        allow update: if false;
        allow delete: if isCoordinator();
    }
  }
}